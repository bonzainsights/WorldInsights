{% extends "base.html" %} {% block title %}Admin Dashboard - WorldInsights{% endblock %} {% block content %}
<section class="admin-page">
    <div class="container">
        <!-- Admin Dashboard Header -->
        <div class="admin-header">
            <h1>üõ°Ô∏è Admin Dashboard</h1>
            <p>Manage users, roles, and subscriptions</p>
        </div>

        <!-- Subscription Overview -->
        <div class="subscription-overview">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-info">
                        <h3>{{ subscription_stats.total_users }}</h3>
                        <p>Total Users</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üÜì</div>
                    <div class="stat-info">
                        <h3>{{ subscription_stats.by_tier.free }}</h3>
                        <p>Free Users</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üî¨</div>
                    <div class="stat-info">
                        <h3>{{ subscription_stats.by_tier.researcher }}</h3>
                        <p>Researchers</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üëë</div>
                    <div class="stat-info">
                        <h3>{{ subscription_stats.by_tier.admin }}</h3>
                        <p>Admins</p>
                    </div>
                </div>

                <div class="stat-card revenue-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-info">
                        <h3>${{ "%.2f"|format(subscription_stats.revenue.monthly) }}</h3>
                        <p>Monthly Revenue (Mock)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div class="admin-dashboard">
            <div class="users-table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Verified</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in all_users %}
                        <tr {% if u.deleted_at %}style="opacity: 0.6; background: rgba(239, 68, 68, 0.05);" {% endif %}>
                            <td>{{ u.id }}</td>
                            <td>
                                {{ u.username }} {% if u.deleted_at %}
                                <span style="color: #EF4444; font-size: 0.75rem; display: block;">
                                    (Deleted {{ ((now() - u.deleted_at).days) }} days ago)
                                </span> {% endif %}
                            </td>
                            <td>{{ u.email }}</td>
                            <td>
                                <span class="badge badge-{{ u.role }}">{{ u.role|title }}</span>
                            </td>
                            <td>
                                {% if u.is_verified %}
                                <span class="status-verified">‚úì</span> {% else %}
                                <span class="status-unverified">‚úó</span> {% endif %}
                            </td>
                            <td>{{ u.created_at.strftime('%Y-%m-%d') if u.created_at else 'N/A' }}</td>
                            <td>
                                {% if u.id != current_user.id %} {% if u.deleted_at %}
                                <form method="POST" action="{{ url_for('auth.recover_user_route') }}" style="display: inline-block;">
                                    <input type="hidden" name="user_id" value="{{ u.id }}">
                                    <button type="submit" class="btn-icon" style="background: #10B981; color: white; padding: 0.5rem 1rem; border-radius: var(--radius-md);" title="Recover User">
                                            ‚ôªÔ∏è Recover
                                        </button>
                                </form>
                                {% else %}
                                <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                                    <form method="POST" action="{{ url_for('auth.change_role') }}" class="role-form" style="display: inline-block;">
                                        <input type="hidden" name="user_id" value="{{ u.id }}">
                                        <select name="role" onchange="this.form.submit()">
                                                <option value="user" {% if u.role == 'user' %}selected{% endif %}>User</option>
                                                <option value="researcher" {% if u.role == 'researcher' %}selected{% endif %}>Researcher</option>
                                                <option value="admin" {% if u.role == 'admin' %}selected{% endif %}>Admin</option>
                                            </select>
                                    </form>
                                    <form method="POST" action="{{ url_for('auth.toggle_verification') }}" style="display: inline-block;">
                                        <input type="hidden" name="user_id" value="{{ u.id }}">
                                        <button type="submit" class="btn-icon" title="{% if u.is_verified %}Unverify{% else %}Verify{% endif %} User">
                                                {% if u.is_verified %}‚ùå{% else %}‚úÖ{% endif %}
                                            </button>
                                    </form>
                                    <button onclick="showAdminDeleteModal({{ u.id }}, '{{ u.username }}')" class="btn-icon btn-delete" title="Delete User">üóëÔ∏è</button>
                                </div>
                                {% endif %} {% else %}
                                <span class="text-muted">You</span> {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<!-- Admin Delete User Modal -->
<div id="adminDeleteModal" class="modal">
    <div class="modal-content">
        <h3 style="color: #EF4444;">‚ö†Ô∏è Delete User Account</h3>
        <div style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid #EF4444; padding: 1rem; margin: 1rem 0; border-radius: 0.5rem;">
            <p style="font-weight: 600; margin-bottom: 0.5rem;">‚ö†Ô∏è WARNING: This action is PERMANENT and IRREVERSIBLE!</p>
            <p style="font-size: 0.875rem; color: var(--text-secondary);">All user data will be permanently deleted and cannot be recovered.</p>
        </div>
        <p id="adminDeleteMessage" style="margin: 1rem 0;">Are you sure you want to delete this user account?</p>
        <div class="form-group" style="margin: 1.5rem 0;">
            <label for="confirmUsername" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                Type "<span id="usernameToDelete" style="color: #EF4444;"></span>" to confirm:
            </label>
            <input type="text" id="confirmUsername" placeholder="Type username here" style="width: 100%; padding: 0.75rem; background: var(--background); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--radius-md); color: var(--text-primary);" autocomplete="off">
        </div>
        <div class="modal-actions">
            <button type="button" onclick="hideAdminDeleteModal()" class="btn btn-secondary">Cancel</button>
            <button type="button" id="confirmDeleteBtn" onclick="showFinalConfirmation()" class="btn btn-primary" style="background: #EF4444; opacity: 0.5;" disabled>Continue</button>
        </div>
    </div>
</div>

<!-- Final Confirmation Modal -->
<div id="finalConfirmModal" class="modal">
    <div class="modal-content">
        <h3 style="color: #EF4444;">üö® FINAL CONFIRMATION</h3>
        <div style="background: rgba(239, 68, 68, 0.15); border: 2px solid #EF4444; padding: 1.5rem; margin: 1rem 0; border-radius: 0.5rem; text-align: center;">
            <p style="font-size: 1.25rem; font-weight: 700; color: #EF4444; margin-bottom: 1rem;">‚ö†Ô∏è LAST CHANCE TO CANCEL ‚ö†Ô∏è</p>
            <p style="font-weight: 600; margin-bottom: 0.5rem;">You are about to PERMANENTLY DELETE:</p>
            <p style="font-size: 1.5rem; font-weight: 700; color: #EF4444; margin: 1rem 0;" id="finalUsername"></p>
            <p style="font-weight: 600; color: var(--text-primary);">This action CANNOT be undone!</p>
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">All user data will be lost forever.</p>
        </div>
        <form method="POST" action="{{ url_for('auth.admin_delete_user_route') }}" id="finalDeleteForm">
            <input type="hidden" name="user_id" id="finalDeleteUserId">
            <div class="modal-actions">
                <button type="button" onclick="hideFinalConfirmation()" class="btn btn-secondary">Cancel - Keep User</button>
                <button type="submit" class="btn btn-primary" style="background: #EF4444; font-weight: 700;">YES, DELETE PERMANENTLY</button>
            </div>
        </form>
    </div>
</div>
{% endblock %} {% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
<style>
    .admin-page {
        padding: 4rem 2rem;
        min-height: 80vh;
    }
    
    .admin-header {
        margin-bottom: 2rem;
    }
    
    .admin-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .admin-header p {
        color: var(--text-secondary);
        font-size: 1.125rem;
    }
    
    .subscription-overview {
        margin-bottom: 2rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: var(--surface);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-4px);
        border-color: rgba(59, 130, 246, 0.3);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .stat-card.revenue-card {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
        border-color: rgba(16, 185, 129, 0.2);
    }
    
    .stat-icon {
        font-size: 2.5rem;
    }
    
    .stat-info h3 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
        color: var(--text-primary);
    }
    
    .stat-info p {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin: 0;
    }
    
    .admin-dashboard {
        background: var(--surface);
        border-radius: var(--radius-xl);
        padding: 2.5rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .users-table-container {
        overflow-x: auto;
    }
    
    .users-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .users-table th,
    .users-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .users-table th {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .users-table tr:hover {
        background: rgba(255, 255, 255, 0.02);
    }
    
    .badge {
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .badge-user {
        background: rgba(59, 130, 246, 0.1);
        color: #60A5FA;
    }
    
    .badge-researcher {
        background: rgba(139, 92, 246, 0.1);
        color: #A78BFA;
    }
    
    .badge-admin {
        background: rgba(16, 185, 129, 0.1);
        color: #10B981;
    }
    
    .role-form select {
        padding: 0.5rem 1rem;
        background: var(--background);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        cursor: pointer;
    }
    
    .status-verified {
        color: #10B981;
        font-weight: 600;
    }
    
    .status-unverified {
        color: #EF4444;
        font-weight: 600;
    }
    
    .text-muted {
        color: var(--text-muted);
    }
    
    .btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-md);
        transition: all 0.2s ease;
    }
    
    .btn-icon:hover {
        background: rgba(255, 255, 255, 0.05);
        transform: scale(1.1);
    }
    
    .btn-delete:hover {
        background: rgba(239, 68, 68, 0.1);
    }
    /* Modal */
    
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }
    
    .modal.active {
        display: flex;
    }
    
    .modal-content {
        background: var(--surface);
        padding: 2rem;
        border-radius: var(--radius-xl);
        max-width: 500px;
        width: 90%;
    }
    
    .modal-content h3 {
        margin-bottom: 1rem;
    }
    
    .modal-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    @media (max-width: 768px) {
        .users-table {
            font-size: 0.875rem;
        }
    }
</style>
{% endblock %} {% block extra_js %}
<script>
    let usernameToConfirm = '';
    let userIdToDelete = '';

    function showAdminDeleteModal(userId, username) {
        usernameToConfirm = username;
        userIdToDelete = userId;
        document.getElementById('usernameToDelete').textContent = username;
        document.getElementById('adminDeleteMessage').textContent =
            `Are you sure you want to delete the account for "${username}"?`;
        document.getElementById('confirmUsername').value = '';
        document.getElementById('confirmDeleteBtn').disabled = true;
        document.getElementById('confirmDeleteBtn').style.opacity = '0.5';
        document.getElementById('adminDeleteModal').classList.add('active');
    }

    function hideAdminDeleteModal() {
        document.getElementById('adminDeleteModal').classList.remove('active');
        document.getElementById('confirmUsername').value = '';
    }

    function showFinalConfirmation() {
        const confirmInput = document.getElementById('confirmUsername');
        if (confirmInput.value !== usernameToConfirm) {
            alert('Username does not match. Please type the exact username to confirm deletion.');
            return;
        }

        // Hide first modal and show final confirmation
        document.getElementById('adminDeleteModal').classList.remove('active');
        document.getElementById('finalUsername').textContent = usernameToConfirm;
        document.getElementById('finalDeleteUserId').value = userIdToDelete;
        document.getElementById('finalConfirmModal').classList.add('active');
    }

    function hideFinalConfirmation() {
        document.getElementById('finalConfirmModal').classList.remove('active');
        // Reset everything
        usernameToConfirm = '';
        userIdToDelete = '';
        document.getElementById('confirmUsername').value = '';
    }

    // Enable delete button only when username matches
    document.addEventListener('DOMContentLoaded', function() {
        const confirmInput = document.getElementById('confirmUsername');
        const deleteBtn = document.getElementById('confirmDeleteBtn');

        if (confirmInput && deleteBtn) {
            confirmInput.addEventListener('input', function() {
                if (this.value === usernameToConfirm) {
                    deleteBtn.disabled = false;
                    deleteBtn.style.opacity = '1';
                } else {
                    deleteBtn.disabled = true;
                    deleteBtn.style.opacity = '0.5';
                }
            });
        }
    });
</script>
{% endblock %}